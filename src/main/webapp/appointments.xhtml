<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
<h:head>
    <title>Appointment Management - Hospital Management System</title>
    <style>
        .status-scheduled { color: #007bff; font-weight: bold; }
        .status-completed { color: #28a745; font-weight: bold; }
        .status-canceled { color: #dc3545; font-weight: bold; }
        .appointment-actions { white-space: nowrap; }
        .filter-panel { margin-bottom: 20px; }
    </style>
</h:head>
<h:body>
    <h:form rendered="#{userBean.canManageAppointments}">
        <p:menubar>
            <p:menuitem value="Dashboard" 
                       outcome="#{userBean.admin ? 'admin-dashboard.xhtml' : (userBean.doctor ? 'doctor-dashboard.xhtml' : 'receptionist-dashboard.xhtml')}" 
                       icon="pi pi-home"/>
            <p:menuitem value="Patients" outcome="patients.xhtml" icon="pi pi-users" rendered="#{userBean.canManagePatients}"/>
            <p:menuitem value="Doctors" outcome="doctors.xhtml" icon="pi pi-user" rendered="#{userBean.admin}"/>
            <p:menuitem value="Appointments" outcome="appointments.xhtml" icon="pi pi-calendar"/>
            <p:menuitem value="Logout" action="#{userBean.logout}" icon="pi pi-sign-out"/>
        </p:menubar>

        <div style="padding: 20px;">
            <h2>Appointment Management</h2>
            <p:messages id="messages" showDetail="true" closable="true" autoUpdate="true"/>

            <!-- Search and Filter Panel -->
            <p:panel header="Search &amp; Filter Appointments" toggleable="true" collapsed="false" styleClass="filter-panel">
                <p:panelGrid columns="4" style="width: 100%;">
                    <!-- Search -->
                    <p:outputLabel value="Search:"/>
                    <p:inputText value="#{appointmentBean.searchTerm}" placeholder="Patient, Doctor, or Reason"/>
                    
                    <!-- Status Filter -->
                    <p:outputLabel value="Status:"/>
                    <p:selectOneMenu value="#{appointmentBean.filterStatus}">
                        <f:selectItem itemLabel="All Statuses" itemValue="#{null}"/>
                        <f:selectItems value="#{appointmentBean.statusOptions}" var="status" 
                                     itemValue="#{status}" itemLabel="#{status}"/>
                    </p:selectOneMenu>
                    
                    <!-- Date Range Filter -->
                    <p:outputLabel value="From Date:"/>
                    <p:calendar value="#{appointmentBean.filterStartDate}" pattern="yyyy-MM-dd"/>
                    
                    <p:outputLabel value="To Date:"/>
                    <p:calendar value="#{appointmentBean.filterEndDate}" pattern="yyyy-MM-dd"/>
                </p:panelGrid>
                
                <p:separator/>
                
                <p:commandButton value="Search" action="#{appointmentBean.search}" 
                               update="appointmentTable" icon="pi pi-search" styleClass="ui-button-success"/>
                <p:commandButton value="Apply Filters" action="#{appointmentBean.applyFilters}" 
                               update="appointmentTable" icon="pi pi-filter" styleClass="ui-button-info" style="margin-left: 10px;"/>
                <p:commandButton value="Clear All" action="#{appointmentBean.clearFilters}" 
                               update="appointmentTable @this" icon="pi pi-times" styleClass="ui-button-secondary" style="margin-left: 10px;"/>
            </p:panel>

            <!-- Quick Actions Panel -->
            <p:panel header="Quick Actions" style="margin-bottom: 20px;" rendered="#{userBean.canManageAppointments}">
                <p:commandButton value="Book New Appointment" 
                               action="#{appointmentBean.openBookingDialog}" 
                               oncomplete="PF('bookingDialog').show()"
                               update="bookingForm"
                               icon="pi pi-plus" 
                               styleClass="ui-button-success"/>
                
                <p:commandButton value="View Today's Appointments" 
                               action="#{appointmentBean.viewTodaysAppointments}" 
                               update="appointmentTable"
                               icon="pi pi-calendar" 
                               styleClass="ui-button-info" 
                               style="margin-left: 10px;"/>
                
                <p:commandButton value="Upcoming Appointments" 
                               action="#{appointmentBean.viewUpcomingAppointments}" 
                               update="appointmentTable"
                               icon="pi pi-clock" 
                               styleClass="ui-button-warning" 
                               style="margin-left: 10px;"/>
            </p:panel>

            <!-- Edit Appointment Panel (shown when editing) -->
            <p:panel header="Edit Appointment" rendered="#{appointmentBean.editMode}" style="margin-bottom: 20px;">
                <p:panelGrid columns="2" style="width: 100%;">
                    <p:outputLabel for="editPatient" value="Patient:"/>
                    <p:selectOneMenu id="editPatient" value="#{appointmentBean.appointment.patient}" 
                                   converter="omnifaces.SelectItemsConverter" required="true">
                        <f:selectItem itemLabel="Select Patient..." itemValue="#{null}"/>
                        <f:selectItems value="#{appointmentBean.patients}" var="patient" 
                                     itemValue="#{patient}" 
                                     itemLabel="#{patient.firstName} #{patient.lastName} (#{patient.phoneNumber})"/>
                    </p:selectOneMenu>

                    <p:outputLabel for="editDoctor" value="Doctor:"/>
                    <p:selectOneMenu id="editDoctor" value="#{appointmentBean.appointment.doctor}" 
                                   converter="omnifaces.SelectItemsConverter" required="true">
                        <f:selectItem itemLabel="Select Doctor..." itemValue="#{null}"/>
                        <f:selectItems value="#{appointmentBean.availableDoctors}" var="doctor" 
                                     itemValue="#{doctor}" 
                                     itemLabel="Dr. #{doctor.firstName} #{doctor.lastName} - #{doctor.speciality}"/>
                    </p:selectOneMenu>

                    <p:outputLabel for="editDate" value="Date:"/>
                    <p:calendar id="editDate" value="#{appointmentBean.appointmentDateStr}" 
                              pattern="yyyy-MM-dd" required="true" mindate="#{appointmentBean.minDate}"/>

                    <p:outputLabel for="editTime" value="Time:"/>
                    <p:selectOneMenu id="editTime" value="#{appointmentBean.appointmentTimeStr}" required="true">
                        <f:selectItem itemLabel="Select Time..." itemValue="#{null}"/>
                        <f:selectItems value="#{appointmentBean.timeSlots}" var="time" 
                                     itemValue="#{time}" itemLabel="#{time}"/>
                    </p:selectOneMenu>

                    <p:outputLabel for="editReason" value="Reason:"/>
                    <p:inputTextarea id="editReason" value="#{appointmentBean.appointment.reason}" 
                                   rows="3" maxlength="255"/>

                    <p:outputLabel for="editStatus" value="Status:"/>
                    <p:selectOneMenu id="editStatus" value="#{appointmentBean.appointment.status}">
                        <f:selectItems value="#{appointmentBean.statusOptions}" var="status" 
                                     itemValue="#{status}" itemLabel="#{status}"/>
                    </p:selectOneMenu>
                </p:panelGrid>

                <p:separator/>

                <p:commandButton value="Update Appointment" 
                               action="#{appointmentBean.updateAppointment}" 
                               update="messages appointmentTable"
                               styleClass="ui-button-warning" 
                               icon="pi pi-pencil"/>
                
                <p:commandButton value="Cancel Edit" 
                               action="#{appointmentBean.cancelEdit}" 
                               update="@form"
                               styleClass="ui-button-secondary" 
                               style="margin-left: 10px;" 
                               icon="pi pi-times"/>
            </p:panel>

            <!-- Appointments Table -->
            <p:panel header="Appointments List">
                <p:dataTable id="appointmentTable" 
                           value="#{appointmentBean.filteredAppointments}" 
                           var="appointment" 
                           paginator="true" 
                           rows="15" 
                           paginatorPosition="bottom"
                           emptyMessage="No appointments found."
                           sortBy="#{appointment.appointmentDate}" 
                           sortOrder="descending"
                           filteredValue="#{appointmentBean.filteredAppointments}">
                    
                    <p:column headerText="ID" sortBy="#{appointment.appointmentID}" style="width: 60px;">
                        #{appointment.appointmentID}
                    </p:column>

                    <p:column headerText="Date" sortBy="#{appointment.appointmentDate}" style="width: 100px;">
                        <h:outputText value="#{appointment.appointmentDate}">
                            <f:convertDateTime pattern="yyyy-MM-dd"/>
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Time" sortBy="#{appointment.appointmentTime}" style="width: 80px;">
                        <h:outputText value="#{appointment.appointmentTime}">
                            <f:convertDateTime pattern="HH:mm" type="time"/>
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Patient" sortBy="#{appointment.patient.lastName}">
                        #{appointment.patient.firstName} #{appointment.patient.lastName}
                        <br/>
                        <small style="color: #666;">#{appointment.patient.phoneNumber}</small>
                    </p:column>

                    <p:column headerText="Doctor" sortBy="#{appointment.doctor.lastName}">
                        Dr. #{appointment.doctor.firstName} #{appointment.doctor.lastName}
                        <br/>
                        <small style="color: #666;">#{appointment.doctor.speciality}</small>
                    </p:column>

                    <p:column headerText="Reason">
                        <h:outputText value="#{appointment.reason}" 
                                    title="#{appointment.reason}"
                                    style="display: block; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"/>
                    </p:column>

                    <p:column headerText="Status" sortBy="#{appointment.status}" style="width: 100px;">
                        <h:outputText value="#{appointment.status}" 
                                    styleClass="status-#{appointment.status.toString().toLowerCase()}"/>
                    </p:column>

                    <p:column headerText="Actions" style="width: 250px;" styleClass="appointment-actions">
                        <p:commandButton value="View" 
                                       action="#{appointmentBean.viewDetails(appointment)}" 
                                       oncomplete="PF('appointmentDetailsDialog').show()" 
                                       update="appointmentDetailsPanel"
                                       styleClass="ui-button-info" 
                                       icon="pi pi-eye" 
                                       style="margin: 1px;"/>
                        
                        <p:commandButton value="Edit" 
                                       action="#{appointmentBean.editAppointment(appointment)}" 
                                       update="@form"
                                       styleClass="ui-button-warning" 
                                       icon="pi pi-pencil" 
                                       style="margin: 1px;"
                                       rendered="#{appointmentBean.canEditAppointment(appointment)}"/>
                        
                        <p:commandButton value="Complete" 
                                       action="#{appointmentBean.completeAppointment(appointment.appointmentID)}" 
                                       update="messages appointmentTable"
                                       styleClass="ui-button-success" 
                                       icon="pi pi-check" 
                                       style="margin: 1px;"
                                       rendered="#{appointmentBean.canCompleteAppointment(appointment)}"
                                       onclick="return confirm('Mark this appointment as completed?');"/>
                        
                        <p:commandButton value="Cancel" 
                                       action="#{appointmentBean.cancelAppointment(appointment.appointmentID)}" 
                                       update="messages appointmentTable"
                                       styleClass="ui-button-danger" 
                                       icon="pi pi-times" 
                                       style="margin: 1px;"
                                       rendered="#{appointmentBean.canCancelAppointment(appointment)}"
                                       onclick="return confirm('Cancel this appointment?');"/>
                        
                        <p:commandButton value="Delete" 
                                       action="#{appointmentBean.deleteAppointment(appointment.appointmentID)}" 
                                       update="messages appointmentTable"
                                       styleClass="ui-button-danger" 
                                       icon="pi pi-trash" 
                                       style="margin: 1px;"
                                       rendered="#{appointmentBean.canDeleteAppointment()}"
                                       onclick="return confirm('Permanently delete this appointment?');"/>
                    </p:column>
                </p:dataTable>
            </p:panel>
        </div>

        <!-- Book Appointment Dialog -->
        <p:dialog header="Book New Appointment" widgetVar="bookingDialog" modal="true" width="600" height="500">
            <h:form id="bookingForm">
                <p:messages showDetail="true" closable="true"/>
                
                <p:panelGrid columns="2" style="width: 100%;">
                    <p:outputLabel for="patient" value="Patient:"/>
                    <p:selectOneMenu id="patient" value="#{appointmentBean.appointment.patient}" 
                                   converter="omnifaces.SelectItemsConverter" required="true">
                        <f:selectItem itemLabel="Select Patient..." itemValue="#{null}"/>
                        <f:selectItems value="#{appointmentBean.patients}" var="patient" 
                                     itemValue="#{patient}" 
                                     itemLabel="#{patient.firstName} #{patient.lastName} (#{patient.phoneNumber})"/>
                    </p:selectOneMenu>

                    <p:outputLabel for="doctor" value="Doctor:"/>
                    <p:selectOneMenu id="doctor" value="#{appointmentBean.appointment.doctor}" 
                                   converter="omnifaces.SelectItemsConverter" required="true">
                        <f:selectItem itemLabel="Select Doctor..." itemValue="#{null}"/>
                        <f:selectItems value="#{appointmentBean.availableDoctors}" var="doctor" 
                                     itemValue="#{doctor}" 
                                     itemLabel="Dr. #{doctor.firstName} #{doctor.lastName} - #{doctor.speciality}"/>
                    </p:selectOneMenu>

                    <p:outputLabel for="appointmentDate" value="Date:"/>
                    <p:calendar id="appointmentDate" value="#{appointmentBean.appointmentDateStr}" 
                              pattern="yyyy-MM-dd" required="true" mindate="#{appointmentBean.minDate}"/>

                    <p:outputLabel for="appointmentTime" value="Time:"/>
                    <p:selectOneMenu id="appointmentTime" value="#{appointmentBean.appointmentTimeStr}" required="true">
                        <f:selectItem itemLabel="Select Time..." itemValue="#{null}"/>
                        <f:selectItems value="#{appointmentBean.timeSlots}" var="time" 
                                     itemValue="#{time}" itemLabel="#{time}"/>
                    </p:selectOneMenu>

                    <p:outputLabel for="reason" value="Reason:"/>
                    <p:inputTextarea id="reason" value="#{appointmentBean.appointment.reason}" 
                                   rows="3" maxlength="255" placeholder="Reason for appointment"/>
                </p:panelGrid>

                <p:separator/>

                <p:commandButton value="Book Appointment" 
                               action="#{appointmentBean.bookAppointment}" 
                               update="messages @form:appointmentTable"
                               oncomplete="if (args &amp;&amp; !args.validationFailed) PF('bookingDialog').hide();"
                               styleClass="ui-button-success" 
                               icon="pi pi-plus"/>
                
                <p:commandButton value="Cancel" 
                               action="#{appointmentBean.closeBookingDialog}" 
                               oncomplete="PF('bookingDialog').hide()"
                               update="bookingForm"
                               styleClass="ui-button-secondary" 
                               style="margin-left: 10px;" 
                               icon="pi pi-times"/>
            </h:form>
        </p:dialog>

        <!-- Appointment Details Dialog -->
        <p:dialog header="Appointment Details" widgetVar="appointmentDetailsDialog" modal="true" width="600" height="400">
            <p:panel id="appointmentDetailsPanel">
                <p:panelGrid columns="2" rendered="#{appointmentBean.selectedAppointment != null}">
                    <h:outputText value="Appointment ID:" style="font-weight: bold;"/>
                    <h:outputText value="#{appointmentBean.selectedAppointment.appointmentID}"/>
                    
                    <h:outputText value="Date:" style="font-weight: bold;"/>
                    <h:outputText value="#{appointmentBean.selectedAppointment.appointmentDate}">
                        <f:convertDateTime pattern="EEEE, MMMM dd, yyyy"/>
                    </h:outputText>
                    
                    <h:outputText value="Time:" style="font-weight: bold;"/>
                    <h:outputText value="#{appointmentBean.selectedAppointment.appointmentTime}">
                        <f:convertDateTime pattern="HH:mm" type="time"/>
                    </h:outputText>
                    
                    <h:outputText value="Patient:" style="font-weight: bold;"/>
                    <h:outputText value="#{appointmentBean.selectedAppointment.patient.firstName} #{appointmentBean.selectedAppointment.patient.lastName}"/>
                    
                    <h:outputText value="Patient Phone:" style="font-weight: bold;"/>
                    <h:outputText value="#{appointmentBean.selectedAppointment.patient.phoneNumber}"/>
                    
                    <h:outputText value="Doctor:" style="font-weight: bold;"/>
                    <h:outputText value="Dr. #{appointmentBean.selectedAppointment.doctor.firstName} #{appointmentBean.selectedAppointment.doctor.lastName}"/>
                    
                    <h:outputText value="Speciality:" style="font-weight: bold;"/>
                    <h:outputText value="#{appointmentBean.selectedAppointment.doctor.speciality}"/>
                    
                    <h:outputText value="Status:" style="font-weight: bold;"/>
                    <h:outputText value="#{appointmentBean.selectedAppointment.status}" 
                                styleClass="status-#{appointmentBean.selectedAppointment.status.toString().toLowerCase()}"/>
                    
                    <h:outputText value="Reason:" style="font-weight: bold;"/>
                    <h:outputText value="#{appointmentBean.selectedAppointment.reason}"/>
                </p:panelGrid>
            </p:panel>
        </p:dialog>
    </h:form>

    <!-- Access Denied -->
    <h:panelGroup rendered="#{!userBean.canManageAppointments}">
        <p:panel header="Access Denied">
            <p>You do not have permission to manage appointments.</p>
            <p:commandButton value="Go to Login" outcome="login.xhtml"/>
        </p:panel>
    </h:panelGroup>
</h:body>
</html>
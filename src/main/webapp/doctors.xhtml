<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
<h:head>
    <title>Doctor Management - Hospital Management System</title>
    <style>
        .availability-available { color: #28a745; font-weight: bold; }
        .availability-unavailable { color: #dc3545; font-weight: bold; }
        .doctor-actions { white-space: nowrap; }
        .stats-panel { margin-bottom: 20px; }
        .filter-panel { margin-bottom: 20px; }
    </style>
</h:head>
<h:body>
    <h:form rendered="#{userBean.canManageDoctors or userBean.doctor}">
        <p:menubar>
            <p:menuitem value="Dashboard"
                        outcome="#{userBean.admin ? 'admin-dashboard.xhtml' : 'doctor-dashboard.xhtml'}"
                        icon="pi pi-home"/>
            <p:menuitem value="Patients" outcome="patients.xhtml" icon="pi pi-users" rendered="#{userBean.canManagePatients}"/>
            <p:menuitem value="Doctors" outcome="doctors.xhtml" icon="pi pi-user"/>
            <p:menuitem value="Appointments" outcome="appointments.xhtml" icon="pi pi-calendar"/>
            <p:menuitem value="Logout" action="#{userBean.logout}" icon="pi pi-sign-out"/>
        </p:menubar>

        <div style="padding: 20px;">
            <h2>Doctor Management</h2>
            <p:messages id="messages" showDetail="true" closable="true" autoUpdate="true"/>

            <!-- Statistics Panel -->
            <p:panel header="Doctor Statistics" styleClass="stats-panel" rendered="#{userBean.admin}">
                <p:panelGrid columns="4" style="width: 100%;">
                    <p:panel header="Total Doctors" style="text-align: center;">
                        <h:outputText value="#{doctorBean.totalDoctors}" style="font-size: 2em; color: #007bff;"/>
                    </p:panel>

                    <p:panel header="Available" style="text-align: center;">
                        <h:outputText value="#{doctorBean.availableDoctorsCount}" style="font-size: 2em; color: #28a745;"/>
                    </p:panel>

                    <p:panel header="Unavailable" style="text-align: center;">
                        <h:outputText value="#{doctorBean.unavailableDoctorsCount}" style="font-size: 2em; color: #dc3545;"/>
                    </p:panel>

                    <p:panel header="Most Common Speciality" style="text-align: center;">
                        <h:outputText value="#{doctorBean.mostCommonSpeciality}" style="font-size: 1.2em; color: #6c757d;"/>
                    </p:panel>
                </p:panelGrid>
            </p:panel>

            <!-- Search and Filter Panel -->
            <p:panel header="Search &amp; Filter Doctors" toggleable="true" collapsed="false" styleClass="filter-panel">
                <p:panelGrid columns="3" style="width: 100%;">
                    <!-- Search -->
                    <p:outputLabel value="Search:"/>
                    <p:inputText value="#{doctorBean.searchTerm}" placeholder="Name, speciality, phone, or email"/>
                    <p:commandButton value="Search" action="#{doctorBean.search}"
                                     update="doctorTable" icon="pi pi-search" styleClass="ui-button-success"/>

                    <!-- Speciality Filter -->
                    <p:outputLabel value="Speciality:"/>
                    <p:selectOneMenu value="#{doctorBean.filterSpeciality}">
                        <f:selectItem itemLabel="All Specialities" itemValue=""/>
                        <f:selectItems value="#{doctorBean.uniqueSpecialities}" var="spec"
                                       itemValue="#{spec}" itemLabel="#{spec}"/>
                    </p:selectOneMenu>
                    <p:commandButton value="Apply Filters" action="#{doctorBean.applyFilters}"
                                     update="doctorTable" icon="pi pi-filter" styleClass="ui-button-info"/>

                    <!-- Availability Filter -->
                    <p:outputLabel value="Availability:"/>
                    <p:selectOneMenu value="#{doctorBean.filterAvailability}">
                        <f:selectItem itemLabel="All" itemValue="#{null}"/>
                        <f:selectItems value="#{doctorBean.availabilityOptions}" var="avail"
                                       itemValue="#{avail}" itemLabel="#{doctorBean.getAvailabilityLabel(avail)}"/>
                    </p:selectOneMenu>
                    <p:commandButton value="Clear All" action="#{doctorBean.clearFilters}"
                                     update="doctorTable @this" icon="pi pi-times" styleClass="ui-button-secondary"/>
                </p:panelGrid>
            </p:panel>

            <!-- Quick Actions Panel -->
            <p:panel header="Quick Actions" style="margin-bottom: 20px;" rendered="#{doctorBean.canAddDoctor}">
                <p:commandButton value="Add New Doctor"
                                 action="#{doctorBean.showAddDoctorForm}"
                                 update="@form"
                                 icon="pi pi-plus"
                                 styleClass="ui-button-success"/>
            </p:panel>

            <!-- Add Doctor Panel (shown when adding) -->
            <p:panel header="Add New Doctor" rendered="#{doctorBean.showAddForm}" style="margin-bottom: 20px;">
                <p:panelGrid columns="2" style="width: 100%;">
                    <p:outputLabel for="addFirstName" value="First Name:"/>
                    <p:inputText id="addFirstName" value="#{doctorBean.doctor.firstName}" required="true" maxlength="50"/>

                    <p:outputLabel for="addLastName" value="Last Name:"/>
                    <p:inputText id="addLastName" value="#{doctorBean.doctor.lastName}" required="true" maxlength="50"/>

                    <p:outputLabel for="addSpeciality" value="Speciality:"/>
                    <p:autoComplete id="addSpeciality" value="#{doctorBean.doctor.speciality}"
                                    completeMethod="#{doctorBean.commonSpecialities}"
                                    required="true" maxlength="100"/>

                    <p:outputLabel for="addPhone" value="Phone Number:"/>
                    <p:inputText id="addPhone" value="#{doctorBean.doctor.phoneNumber}" required="true" maxlength="15"/>

                    <p:outputLabel for="addEmail" value="Email:"/>
                    <p:inputText id="addEmail" value="#{doctorBean.doctor.email}" required="true" maxlength="50"/>

                    <p:outputLabel for="addAvailability" value="Availability:"/>
                    <p:selectOneMenu id="addAvailability" value="#{doctorBean.doctor.isAvailable}" required="true">
                        <f:selectItems value="#{doctorBean.availabilityOptions}" var="avail"
                                       itemValue="#{avail}" itemLabel="#{doctorBean.getAvailabilityLabel(avail)}"/>
                    </p:selectOneMenu>
                </p:panelGrid>

                <p:separator/>

                <p:commandButton value="Add Doctor"
                                 action="#{doctorBean.addDoctor}"
                                 update="messages doctorTable"
                                 styleClass="ui-button-success"
                                 icon="pi pi-plus"/>

                <p:commandButton value="Cancel"
                                 action="#{doctorBean.hideAddDoctorForm}"
                                 update="@form"
                                 styleClass="ui-button-secondary"
                                 style="margin-left: 10px;"
                                 icon="pi pi-times"/>
            </p:panel>

            <!-- Edit Doctor Panel (shown when editing) -->
            <p:panel header="Edit Doctor" rendered="#{doctorBean.editMode}" style="margin-bottom: 20px;">
                <p:panelGrid columns="2" style="width: 100%;">
                    <p:outputLabel for="editFirstName" value="First Name:"/>
                    <p:inputText id="editFirstName" value="#{doctorBean.doctor.firstName}" required="true" maxlength="50"/>

                    <p:outputLabel for="editLastName" value="Last Name:"/>
                    <p:inputText id="editLastName" value="#{doctorBean.doctor.lastName}" required="true" maxlength="50"/>

                    <p:outputLabel for="editSpeciality" value="Speciality:"/>
                    <p:autoComplete id="editSpeciality" value="#{doctorBean.doctor.speciality}"
                                    completeMethod="#{doctorBean.commonSpecialities}"
                                    required="true" maxlength="100"/>

                    <p:outputLabel for="editPhone" value="Phone Number:"/>
                    <p:inputText id="editPhone" value="#{doctorBean.doctor.phoneNumber}" required="true" maxlength="15"/>

                    <p:outputLabel for="editEmail" value="Email:"/>
                    <p:inputText id="editEmail" value="#{doctorBean.doctor.email}" required="true" maxlength="50"/>

                    <p:outputLabel for="editAvailability" value="Availability:"/>
                    <p:selectOneMenu id="editAvailability" value="#{doctorBean.doctor.isAvailable}" required="true">
                        <f:selectItems value="#{doctorBean.availabilityOptions}" var="avail"
                                       itemValue="#{avail}" itemLabel="#{doctorBean.getAvailabilityLabel(avail)}"/>
                    </p:selectOneMenu>
                </p:panelGrid>

                <p:separator/>

                <p:commandButton value="Update Doctor"
                                 action="#{doctorBean.updateDoctor}"
                                 update="messages doctorTable"
                                 styleClass="ui-button-warning"
                                 icon="pi pi-pencil"/>

                <p:commandButton value="Cancel Edit"
                                 action="#{doctorBean.cancelEdit}"
                                 update="@form"
                                 styleClass="ui-button-secondary"
                                 style="margin-left: 10px;"
                                 icon="pi pi-times"/>
            </p:panel>

            <!-- Doctors Table -->
            <p:panel header="Doctors List">
                <p:dataTable id="doctorTable"
                             value="#{doctorBean.filteredDoctors}"
                             var="doctor"
                             paginator="true"
                             rows="10"
                             paginatorPosition="bottom"
                             emptyMessage="No doctors found."
                             sortBy="#{doctor.lastName}"
                             sortOrder="ascending">

                    <p:column headerText="ID" sortBy="#{doctor.doctorID}" style="width: 60px;">
                        #{doctor.doctorID}
                    </p:column>

                    <p:column headerText="Name" sortBy="#{doctor.lastName}">
                        Dr. #{doctor.firstName} #{doctor.lastName}
                    </p:column>

                    <p:column headerText="Speciality" sortBy="#{doctor.speciality}">
                        #{doctor.speciality}
                    </p:column>

                    <p:column headerText="Phone" sortBy="#{doctor.phoneNumber}">
                        #{doctor.phoneNumber}
                    </p:column>

                    <p:column headerText="Email" sortBy="#{doctor.email}">
                        #{doctor.email}
                    </p:column>

                    <p:column headerText="Availability" sortBy="#{doctor.isAvailable}" style="width: 120px;">
                        <h:outputText value="#{doctor.isAvailable}"
                                      styleClass="availability-#{doctor.isAvailable.toString().toLowerCase()}"/>
                    </p:column>

                    <p:column headerText="Actions" style="width: 300px;" styleClass="doctor-actions">
                        <p:commandButton value="View"
                                         action="#{doctorBean.viewDetails(doctor)}"
                                         oncomplete="PF('doctorDetailsDialog').show()"
                                         update="doctorDetailsPanel"
                                         styleClass="ui-button-info"
                                         icon="pi pi-eye"
                                         style="margin: 1px;"/>

                        <p:commandButton value="Edit"
                                         action="#{doctorBean.editDoctor(doctor)}"
                                         update="@form"
                                         styleClass="ui-button-warning"
                                         icon="pi pi-pencil"
                                         style="margin: 1px;"
                                         rendered="#{doctorBean.canEditDoctor}"/>

                        <p:commandButton value="#{doctor.isAvailable == 'AVAILABLE' ? 'Set Unavailable' : 'Set Available'}"
                                         action="#{doctorBean.toggleAvailability(doctor)}"
                                         update="messages doctorTable"
                                         styleClass="#{doctor.isAvailable == 'AVAILABLE' ? 'ui-button-warning' : 'ui-button-success'}"
                                         icon="pi pi-refresh"
                                         style="margin: 1px;"
                                         rendered="#{doctorBean.canToggleAvailability}"
                                         onclick="return confirm('Change availability status?');"/>

                        <p:commandButton value="Delete"
                                         action="#{doctorBean.deleteDoctor(doctor.doctorID)}"
                                         update="messages doctorTable"
                                         styleClass="ui-button-danger"
                                         icon="pi pi-trash"
                                         style="margin: 1px;"
                                         rendered="#{doctorBean.canDeleteDoctor}"
                                         onclick="return confirm('Are you sure you want to delete this doctor?');"/>
                    </p:column>
                </p:dataTable>
            </p:panel>
        </div>

        <!-- Doctor Details Dialog -->
        <p:dialog header="Doctor Details" widgetVar="doctorDetailsDialog" modal="true" width="600" height="400">
            <p:panel id="doctorDetailsPanel">
                <p:panelGrid columns="2" rendered="#{doctorBean.selectedDoctor != null}">
                    <h:outputText value="Doctor ID:" style="font-weight: bold;"/>
                    <h:outputText value="#{doctorBean.selectedDoctor.doctorID}"/>

                    <h:outputText value="Full Name:" style="font-weight: bold;"/>
                    <h:outputText value="#{doctorBean.getDoctorFullName(doctorBean.selectedDoctor)}"/>

                    <h:outputText value="Speciality:" style="font-weight: bold;"/>
                    <h:outputText value="#{doctorBean.selectedDoctor.speciality}"/>

                    <h:outputText value="Phone Number:" style="font-weight: bold;"/>
                    <h:outputText value="#{doctorBean.selectedDoctor.phoneNumber}"/>

                    <h:outputText value="Email:" style="font-weight: bold;"/>
                    <h:outputText value="#{doctorBean.selectedDoctor.email}"/>

                    <h:outputText value="Availability:" style="font-weight: bold;"/>
                    <h:outputText value="#{doctorBean.getAvailabilityLabel(doctorBean.selectedDoctor.isAvailable)}"
                                  style="#{doctorBean.getAvailabilityStyle(doctorBean.selectedDoctor.isAvailable)}"/>
                </p:panelGrid>
            </p:panel>
        </p:dialog>
    </h:form>

    <!-- Access Denied -->
    <h:panelGroup rendered="#{!userBean.canManageDoctors and !userBean.doctor}">
        <p:panel header="Access Denied">
            <p>You do not have permission to view doctor information.</p>
            <p:commandButton value="Go to Dashboard" outcome="#{userBean.admin ? 'admin-dashboard.xhtml' : 'login.xhtml'}"/>
        </p:panel>
    </h:panelGroup>
</h:body>
</html>